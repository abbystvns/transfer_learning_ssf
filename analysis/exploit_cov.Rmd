---
title: "Exploiting the covariance structure in the AltMin procedure"
author: "Abby Stevens"
date: "2020-04-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---
## Modified AltMin procedure
Suppose we have observational data an K simulations of the same size, ala LENS. The observations are given by

$$y_{obs} = X_{obs}\beta + \epsilon, \quad \epsilon \sim N(0, \sigma^2 I)$$

And the simulations are given by, for $j=1, \dots K$, 

$$y_{sim}^{(j)} = X_{sim}^{(j)}(\beta + \Delta_j) + \epsilon_j, \quad \epsilon_j \sim N(0, \sigma^2I), \quad \Delta_j \sim N(0, \Sigma_{\Delta})$$

or 


$$y_{sim}^{(j)} = X_{sim}^{(j)}\beta + \eta_j, \quad \eta_j \sim N(0, \tilde{\Sigma}_j), \quad \tilde{\Sigma}_j = X_{sim}^{(j)}\Sigma_{\Delta}(X_{sim}^{(j)})^T + \sigma^2I$$

Procedure:

| **init** $\hat{\beta}_1$
| for  $t=1, \dots, T$:
|      **covariance estimation:**
|      $\hat{\sigma}^2_t = \frac{1}{n_o} \| y_{obs} - X_{obs}\hat{\beta}_t\|_2^2$
|      for j = 1, ..., K:
|             $\hat{\tilde{\Sigma}}_j = (y_{sim} - X_{sim}\hat{\beta}_t)(y_{sim} - X_{sim}\hat{\beta}_t)^T$
|             $S_j = \hat{\tilde{\Sigma}}_j - \hat{\sigma}_t^2I$
|             $\hat{\Sigma}_{\Delta,j} = argmin_{\Sigma\succ 0} \| X_{sim} \Sigma X_{sim}^T - S_j\|_F^2$
|      $\hat{\Sigma}_{\Delta} = \frac{1}{K} \sum_{j=1}^K \hat{\Sigma}_{\Delta,j}$
|      $\hat{\tilde{\Sigma}}_t = X_{sim} \hat{\Sigma}_{\Delta}X_{sim}^T + \hat{\sigma}_t^2I$
|       **$\beta$ estimation:**
|       $\hat{\beta}_{t+1} = argmin_{\beta} \left\{\frac{1}{\hat{\sigma}^2_t}\| y_{obs} - X_{obs}\beta \|_2^2 + \frac{1}{K}\sum_{j=1}^K \| \hat{\tilde{\Sigma}}_t^{-1/2} (y_{sim}^{(j)} - X_{sim}^{(j)}\beta)\|_2^2 + \lambda f(\beta) \right\}$
## Overview

When trying to combine simulations and observations drawn from our Gaussian setting, we are solving for $\beta$ in the following system:


$$\tilde{y} = \tilde{X} \beta + \epsilon, \quad \quad \epsilon 
\sim N(0, \Sigma_*), \quad \quad \Sigma_* = \begin{bmatrix}
\sigma^2I_{n_o} & 0\\
0 & X_s\Sigma_{\Delta}X_s^T + \sigma^2I_{n_s}\end{bmatrix}$$


where $$ \tilde{y} = \begin{bmatrix}
y_{obs} \\
y_{sim}
\end{bmatrix} \quad \text{and} \quad \tilde{X} = \begin{bmatrix}
X_{obs}\\
X_{sim}
\end{bmatrix}
$$

So the AltMin procedure (where we keep all data in one group) proceeds as follows:


\begin{align*}
\hat{\Sigma}_{(t+1)} &= \left(\tilde{y} - \tilde{X} \hat{\theta}_{(t)}\right) \left(\tilde{y} - \tilde{X} \hat{\theta}_{(t)}\right)^T \\

\hat{\theta}_{(t+1)} &= arg\min_{\theta \in \mathbb{R}^p} \frac{1}{2}\| \hat{\Sigma}_{(t+1)}^{-\frac{1}{2}}(\tilde{y} - \tilde{X}\theta)\|_2^2 \quad \text{s.t.} \quad f(\theta) \leq \lambda
\end{align*}

When the true covariance is known, the MAP estimator achieves good MSE (see [here](map_compare.html) for notebook with code and plot). We want to dig deeper into the estimation of $\Sigma_*$ using AltMin and experiment with ways to exploit the structure in our setting to improve this estimation.

Because our setting is high-dimensional, we know that estimating $\Sigma$ will be difficult. It is possible that this becomes even more difficult because, in the AltMin procedure (or when computing the MAP estimator) we are actually using an estimate of $\Sigma^{-1}$. 

## Tasks

### 1. Structured covariance estimation
Pose the covariance estimation step in AltMin follows: 


1. $\hat{\sigma}^2 = \frac{1}{n_o}\|y_{obs} - X_{obs}\hat{\theta}\|_2^2$
2. $\hat{\tilde{\Sigma}} = \left(y_{sim} - X_{sim}\hat{\theta}\right)\left(y_{sim} - X_{sim}\hat{\theta}\right)^T$
3. $\hat{\Sigma}_{\Delta} = \text{arg} \min_{\Sigma \succ 0} \|\hat{\tilde{\Sigma}} - X_{sim} \Sigma X_{sim}^T - \hat{\sigma}^2I_{n_s} \|_F^2$
4. $\hat{\Sigma}_* = \begin{bmatrix}
\hat{\sigma}^2I_{n_o} & 0\\
0 & X_s\hat{\Sigma}_{\Delta}X_s^T + \hat{\sigma}^2I_{n_s}\end{bmatrix}$

The third step involves an optimization problem over $p \times p$ positive definite matrices - we should test and see what happens to the error as $p$ increases.

Update 4/18: Qin put together helpful [slides](sigmadelta.pdf) and [code](https://github.com/abbystvns/transfer_learning_ssf/blob/master/code/fgm.m) based on [this](https://arxiv.org/pdf/1612.01354.pdf) paper. 

### 2. Deep-dive into impact of covariance on AltMin procedure
Following the call on 4/2/20, we should do the following:

1. Plot the accuracy of $\Sigma_{\Delta}$ and $\tilde{\Sigma}^{-1}$ for different combinations of $p$, $n_s$, $n_o$

2. See what happens to these estimates across number of iterations
3. Initilalize AltMin at ground truth $\Sigma_{\Delta}$ and see what happens as the procedure iterates.

Code for initial exploration of this question found [here](covariance_explorations.html).




